import{b as N,m as q,g as Ie,d as Se,a as Fe,c as Ne}from"./getColorTheme-3ad3fafe.js";import{c as O}from"./config-08cc2f6c.js";import"./index-55e7bd22.js";function se(){return Math.random().toString(36).substr(2,5)}let U,A=new Map;async function Ee(){U=await(await fetch(O.placesSource,{mode:"cors"})).json(),U.features.forEach(a=>{A.set(a.properties.labelId,a)});const r=Re(),n=Ae(r);return n&&N.fire("unsaved-changes-detected",n),r}function fe(e){localStorage.setItem("places",JSON.stringify(e))}function ke(e,r,n,a,f){let c=se();for(;A.has(c);)c=se();const s={type:"Feature",geometry:{type:"Point",coordinates:[n.lng,n.lat].map(u=>Math.round(u*1e3)/1e3)},properties:{symbolzoom:Math.ceil(a),name:r,labelId:c}};return f!==void 0&&(s.properties.ownerId=f),e.features.push(s),A.set(c,s),fe(e),e}function Me(e,r,n,a,f){if(!n)r.features=r.features.filter(c=>c.properties.labelId!==e),A.delete(e);else{const c=r.features.find(s=>s.properties.labelId===e);c.properties.name=n,c.properties.symbolzoom=Math.ceil(f),c.geometry.coordinates=[a.lng,a.lat].map(s=>Math.round(s*1e3)/1e3),A.set(e,c)}return fe(r),r}function Re(){const e=JSON.parse(localStorage.getItem("places"))||{type:"FeatureCollection",features:[]};let r=new Map;for(const n of e.features){const a=n.properties.labelId,f=r.get(a);f?r.set(a,Object.assign({},f,n)):r.set(a,n)}return A.forEach((n,a)=>{r.has(a)||r.set(a,n)}),{type:"FeatureCollection",features:Array.from(r.values())}}function Ae(e){if(!U)return!1;for(const r of e.features){const n=r.properties.labelId,a=A.get(n);if(!a||a.properties.name!==r.properties.name||a.properties.symbolzoom!==r.properties.symbolzoom||a.geometry.coordinates[0]!==r.geometry.coordinates[0]||a.geometry.coordinates[1]!==r.geometry.coordinates[1])return!0}return!1}function le(e,r,n){const a=document.createElement("div");a.className="label-marker",a.innerHTML=`<form class="mini-label">
  <input type="text" placeholder="Label" />
  <div class='commands'>
    <a href='#' class="cancel" tabindex="3">Cancel</a>
    <a href='#' class="accept">Save</a>
  </div>
  </div>`,n&&(a.querySelector("input").value=n);let f,c=0,s=0,u=0,m=0;return z(),{element:a,setMarker:h=>{f=h}};function y(h){h.preventDefault(),r(a.querySelector("input").value),E()}function z(){document.addEventListener("keydown",B),a.querySelector("form").addEventListener("submit",y),a.querySelector(".cancel").addEventListener("click",h=>{h.preventDefault(),E()}),a.querySelector(".accept").addEventListener("click",h=>{y(h)}),a.addEventListener("pointerdown",h=>{c=h.clientX,s=h.clientY;let H=e.project(f.getLngLat());u=H.x-c,m=H.y-s,window.addEventListener("pointermove",b,!0),window.addEventListener("pointerup",R,!0)})}function b(h){const H=e.unproject([h.clientX+u,h.clientY+m]);f.setLngLat(H)}function R(){document.removeEventListener("keydown",B),window.removeEventListener("pointermove",b,!0),window.removeEventListener("pointerup",R,!0)}function E(){f.remove(),R()}function B(h){h.key==="Escape"&&(E(),h.preventDefault())}}function He(e){let r;const n=["place-country-1","place-country-1-enriched"];return Ee().then(s=>{e.getSource("place").setData(s),r=s}),{getContextMenuItems:a,getPlaces:()=>r};function a(s,u){const m=n.filter(b=>e.getLayer(b)),y=m.length?e.queryRenderedFeatures(s.point,{layers:m}):[];let z=[];if(y.length){const b=y[0].properties;z.push({text:`Edit ${b.name}`,click:()=>c(y[0].geometry.coordinates,b)})}else z.push({text:"Add label",click:()=>f(s.lngLat,u)});return z}function f(s,u){const m=le(e,z),y=new q.Popup({closeButton:!1});y.setDOMContent(m.element),y.setLngLat(s),y.addTo(e),m.setMarker(y);function z(b){b&&(r=ke(r,b,y.getLngLat(),e.getZoom(),u),e.getSource("place").setData(r),N.fire("unsaved-changes-detected",!0))}}function c(s,u){const m=le(e,z,u.name),y=new q.Popup({closeButton:!1});y.setDOMContent(m.element),y.setLngLat(s),y.addTo(e),m.setMarker(y);function z(b){r=Me(u.labelId,r,b,y.getLngLat(),e.getZoom()),e.getSource("place").setData(r),N.fire("unsaved-changes-detected",!0)}}}const De="#bf2072",je="#e56aaa",Te="#43bfa2",Be="#ffbe0b",ce="#ffffff",ue="#186d59",qe=1.7,Y=5,F="place-country-1",C="place-country-1-enriched",W="persistent-selected-nodes-layer",L=Fe(),V=["case"];L.color.forEach(e=>{V.push(["==",["get","fill"],e.input],e.output)});V.push("#FF0000");function Ve(){const e=new q.Map(Oe());e.dragRotate.disable(),e.touchZoomRotate.disableRotation();const r=Ne();let n,a,f=[],c=[],s=[],u=[],m=0;e.on("load",()=>{e.addLayer(r,"circle-layer"),a=He(e),G(),K(),D(),j()}),e.on("contextmenu",t=>{N.fire("show-tooltip");let o=_(t.point);if(!o)return;const l={items:a.getContextMenuItems(t,o.id),left:t.point.x+"px",top:t.point.y+"px"},i=ee(t.point);if(i){let d=i.properties.label,g=d.split("/");const x=g[g.length-1]||d;l.items.push({text:"List connections of "+x,click:()=>{B(i),Z(t.point,d),N.fire("focus-on-repo",d,o.id)}})}N.fire("show-context-menu",l)}),e.on("mousemove",()=>{}),e.on("click",t=>{N.fire("show-context-menu");const o=ee(t.point);if(!o)return;const l=o.properties.label;if(!l)return;B(o);const i=t.originalEvent.altKey;Z(t.point,l,!i)});const y=fetch(O.bordersSource).then(t=>t.json()),z=y.then(t=>(Array.isArray(t==null?void 0:t.features)?t.features:[]).map(l=>{var g,x;const i=(x=(g=l==null?void 0:l.geometry)==null?void 0:g.coordinates)==null?void 0:x[0];if(!Array.isArray(i)||!i.length)return null;const d=Ke(i);return{id:l.id,ring:i,bbox:d}}).filter(Boolean));return{map:e,dispose(){e.remove()},makeVisible:he,focusOnNodes:be,highlightNodes:xe,highlightRegions:Le,clearSelectionHighlights:H,clearPersistentHighlights:ye,clearRegionHighlights:ge,clearHighlights:me,getPlacesGeoJSON:h,getGroupIdAt:b,getGroupIdsAtCoordinates:R};function b(t,o){const l=Number(t),i=Number(o);return!Number.isFinite(l)||!Number.isFinite(i)?Promise.resolve(void 0):z.then(d=>E(d,l,i))}function R(t=[]){return!Array.isArray(t)||!t.length?Promise.resolve([]):z.then(o=>t.map(l=>{if(!Array.isArray(l)||l.length!==2)return;const i=Number(l[0]),d=Number(l[1]);if(!(!Number.isFinite(i)||!Number.isFinite(d)))return E(o,i,d)}))}function E(t=[],o,l){for(let i=0;i<t.length;i+=1){const d=t[i];if(We(o,l,d.bbox)&&Je(d.ring,o,l))return d.id}}function B(t){var d;const o=t.properties.label;if(!o)return;const[l,i]=t.geometry.coordinates;N.fire("show-tooltip"),N.fire("repo-selected",{text:o,lat:l,lon:i,groupId:(d=t.properties)==null?void 0:d.parent})}function h(){return a.getPlaces()}function H(){n==null||n.cancel(),r.clear(),c=[],K()}function ye(){f=[],G()}function ge(){m+=1,s=[],u=[],D(),j()}function me(){n==null||n.cancel(),r.clear(),f=[],c=[],s=[],u=[],m+=1,G(),K(),D(),j()}function he(t,o,l=!1){const i=()=>{const d=e.project(o.center);Z(d,t)};if(l){e.jumpTo(o),i();return}e.once("moveend",i),e.flyTo(o)}function be(t=[],{padding:o=80,maxZoom:l=8,disableAnimation:i=!1}={}){const d=t.map(Q).filter(Boolean);if(!d.length)return;let g=1/0,x=1/0,S=-1/0,v=-1/0;if(d.forEach(([w,k])=>{w<g&&(g=w),k<x&&(x=k),w>S&&(S=w),k>v&&(v=k)}),g===S&&x===v){const w={center:[g,x],zoom:l};i?e.jumpTo(w):e.flyTo(w);return}const P=e.cameraForBounds([[g,x],[S,v]],{padding:o,maxZoom:l});P&&(i?e.jumpTo(P):e.flyTo(P))}function Q(t={}){const o=Array.isArray(t.coordinates)?t.coordinates:[t.lat,t.lon];if(!Array.isArray(o)||o.length!==2)return null;const l=Number(o[0]),i=Number(o[1]);return!Number.isFinite(l)||!Number.isFinite(i)?null:[l,i]}function xe(t=[]){n==null||n.cancel(),r.clear(),f=t.map(o=>{const l=Q(o);return l?{type:"Feature",geometry:{type:"Point",coordinates:l},properties:{color:o.color||Te,name:o.text||o.name||"",background:o.background||"#222",highlightKind:o.highlightKind||"bulk",textSize:o.textSize||.8,size:o.size||Y*6}}:null}).filter(Boolean),G()}function G(){const t=e.getSource("persistent-selected-nodes");t&&(t.setData({type:"FeatureCollection",features:f}),e.redraw())}function K(){const t=e.getSource("selected-nodes");t&&(t.setData({type:"FeatureCollection",features:c}),e.redraw())}function D(){const t=e.getSource("enriched-regions");t&&(t.setData({type:"FeatureCollection",features:s}),e.redraw())}function Le(t=[]){const o=new Set((Array.isArray(t)?t:[]).filter(i=>i!=null).map(i=>String(i))),l=++m;if(!o.size){s=[],u=[],D(),j();return}u=Array.from(o),j(),y.then(i=>{if(l!==m)return;s=(Array.isArray(i==null?void 0:i.features)?i.features:[]).filter(g=>o.has(String(g==null?void 0:g.id))),D()}).catch(i=>{l===m&&(console.error(i),s=[],u=[],D(),j())})}function j(){if(!e.getLayer(F))return;const t=X(),o=pe(),l=u.length>0,i=Xe(u),d=l?["all",o,["!",i]]:o;if(e.getLayer(W)&&e.moveLayer(F,W),e.setLayerZoomRange(F,0,10),e.setFilter(F,d),e.setLayoutProperty(F,"text-size",t),e.setLayoutProperty(F,"text-allow-overlap",!1),e.setLayoutProperty(F,"text-ignore-placement",!1),e.setPaintProperty(F,"text-color",L.placeLabelsColor),e.setPaintProperty(F,"text-halo-color",L.placeLabelsHaloColor),e.setPaintProperty(F,"text-halo-width",L.placeLabelsHaloWidth),!l){Ce();return}ze(),e.getLayer(C)&&(e.setLayerZoomRange(C,0,24),e.setFilter(C,i),e.setLayoutProperty(C,"text-size",X(qe)),e.setLayoutProperty(C,"text-allow-overlap",!0),e.setLayoutProperty(C,"text-ignore-placement",!0),e.setPaintProperty(C,"text-color",ce),e.setPaintProperty(C,"text-halo-color",ue),e.setPaintProperty(C,"text-halo-width",de()),e.moveLayer(C))}function ze(){if(e.getLayer(C))return;const t={id:C,type:"symbol",source:"place",layout:{"text-font":["Roboto Condensed Regular"],"text-size":X(),"symbol-sort-key":["get","symbolzoom"],"text-field":"{name}","text-max-width":6,"text-line-height":1.1,"text-letter-spacing":0,"text-allow-overlap":!0,"text-ignore-placement":!0},paint:{"text-color":ce,"text-halo-color":ue,"text-halo-width":de()}};if(e.getLayer(W)){e.addLayer(t,W);return}e.addLayer(t)}function Ce(){e.getLayer(C)&&e.removeLayer(C)}function _(t){return e.queryRenderedFeatures(t,{layers:["polygon-layer"]})[0]}function Z(t,o,l=!0){const i=_(t);if(!i)return;const d=i.id;if(d===void 0)return;const g=Ge(i.properties);let x=Ie(g);r.clear(),n==null||n.cancel();let S=!1,v={type:"FeatureCollection",features:[]};n=Se(d).then(P=>{if(S)return;let w=[],k,J=new Map;e.querySourceFeatures("points-source",{sourceLayer:"points",filter:["==","parent",d]}).forEach(p=>{const M=p.geometry.coordinates,I=Number(p.properties.size);J.set(p.properties.label,{lngLat:M,size:Number.isFinite(I)&&I>0?I:Y})});const te=p=>{var T;const M=((T=P.getNode(p))==null?void 0:T.data)||{},I=Number(M.size??M.s);return Number.isFinite(I)&&I>0?I:Y};P.forEachLink(p=>{var ae;if((ae=p.data)!=null&&ae.e&&l)return;const M=J.get(p.fromId)||{lngLat:P.getNode(p.fromId).data.l,size:te(p.fromId)},I=J.get(p.toId)||{lngLat:P.getNode(p.toId).data.l,size:te(p.toId)},T=M.lngLat,$=I.lngLat,re=q.MercatorCoordinate.fromLngLat(T),oe=q.MercatorCoordinate.fromLngLat($),ne=o===p.fromId||o===p.toId,ie={from:[re.x,re.y],to:[oe.x,oe.y],color:ne?4294967295:x};if(ne){if(w.push(ie),!k){k=o===p.fromId?T:$;const Pe=o===p.fromId?M.size:I.size;v.features.push({type:"Feature",geometry:{type:"Point",coordinates:k},properties:{color:De,name:o,background:g,highlightKind:"click",textSize:1.2,size:Pe}})}let we=o===p.fromId?p.toId:p.fromId;const ve=o===p.fromId?I.size:M.size;v.features.push({type:"Feature",geometry:{type:"Point",coordinates:o===p.fromId?$:T},properties:{color:je,name:we,background:g,highlightKind:"click",textSize:.8,size:ve}})}else r.addLine(ie)}),w.forEach(p=>{r.addLine(p)}),c=v.features,K()}),n.cancel=()=>{S=!0}}function ee(t){let o=16,l=16;const i=e.queryRenderedFeatures([[t.x-o/2,t.y-l/2],[t.x+o/2,t.y+l/2]],{layers:["circle-layer"]});if(!i.length)return;let d=1/0,g=null;return i.forEach(x=>{let S=x.geometry.coordinates,v=S[0]-t.x,P=S[1]-t.y,w=v*v+P*P;w<d&&(d=w,g=x)}),g}}function Oe(){return{hash:!0,container:"map",center:[0,0],zoom:2,style:{version:8,glyphs:O.glyphsSource,sources:{"borders-source":{type:"geojson",data:O.bordersSource},"points-source":{type:"vector",tiles:[O.vectorTilesTiles],minzoom:3,maxzoom:5,center:[-9.84375,4.213679,7]},place:{type:"geojson",data:{type:"FeatureCollection",features:[]}},"selected-nodes":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"persistent-selected-nodes":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"enriched-regions":{type:"geojson",data:{type:"FeatureCollection",features:[]}}},layers:[{id:"background",type:"background",paint:{"background-color":L.background}},{id:"polygon-layer",type:"fill",source:"borders-source",filter:["==","$type","Polygon"],paint:{"fill-color":V}},{id:"enriched-regions-line-underlay",type:"line",source:"enriched-regions",paint:{"line-color":Be,"line-width":["interpolate",["linear"],["zoom"],3,1,8,1.6,14,3],"line-opacity":.7}},{id:"border-highlight",type:"line",source:"borders-source",layout:{visibility:"none"},paint:{"line-color":"#FFF","line-width":4}},{id:"circle-layer",type:"circle",source:"points-source","source-layer":"points",filter:["==","$type","Point"],paint:{"circle-color":L.circleColor,"circle-opacity":["interpolate",["linear"],["zoom"],5,.1,15,.9],"circle-stroke-color":L.circleStrokeColor,"circle-stroke-width":1,"circle-stroke-opacity":["interpolate",["linear"],["zoom"],8,0,15,.9],"circle-radius":["interpolate",["linear"],["zoom"],5,["*",["get","size"],.1],23,["*",["get","size"],1.5]]}},{id:"label-layer",type:"symbol",source:"points-source","source-layer":"points",filter:[">=",["zoom"],5],layout:{"text-font":["Roboto Condensed Regular"],"text-field":["slice",["get","label"],["+",["index-of","/",["get","label"]],1]],"text-anchor":"top","text-max-width":10,"symbol-sort-key":["-",0,["get","size"]],"symbol-spacing":500,"text-offset":[0,.5],"text-size":["interpolate",["linear"],["zoom"],8,["/",["get","size"],4],10,["+",["get","size"],8]]},paint:{"text-color":L.circleLabelsColor,"text-halo-color":L.circleLabelsHaloColor,"text-halo-width":L.circleLabelsHaloWidth}},{id:"selected-nodes-layer",type:"circle",source:"selected-nodes",paint:{"circle-color":["get","color"],"circle-radius":["interpolate",["linear"],["zoom"],0,["max",3,["*",["get","size"],.2]],5,["max",4,["*",["get","size"],.25]],23,["*",["get","size"],1.6]],"circle-stroke-color":"#ffffff","circle-stroke-width":["interpolate",["linear"],["zoom"],0,.5,8,1.5,15,2],"circle-stroke-opacity":.9}},{id:"selected-nodes-labels-layer",type:"symbol",source:"selected-nodes",layout:{"text-font":["Roboto Condensed Regular"],"text-field":["get","name"],"text-anchor":"top","text-max-width":10,"symbol-sort-key":["-",0,["get","textSize"]],"symbol-spacing":500,"text-offset":[0,.5],"text-size":["interpolate",["linear"],["zoom"],0,["max",8,["/",["get","size"],2.5]],8,["/",["get","size"],4],10,["+",["get","size"],8]]},paint:{"text-color":"#fff","text-halo-color":["get","color"],"text-halo-width":2}},{id:"place-country-1",maxzoom:10,type:"symbol",source:"place",layout:{"text-font":["Roboto Condensed Bold"],"text-size":X(),"symbol-sort-key":["get","symbolzoom"],"text-field":"{name}","text-max-width":6,"text-line-height":1.1,"text-letter-spacing":0},paint:{"text-color":L.placeLabelsColor,"text-halo-color":L.placeLabelsHaloColor,"text-halo-width":L.placeLabelsHaloWidth},filter:pe()},{id:"persistent-selected-nodes-layer",type:"circle",source:"persistent-selected-nodes",paint:{"circle-color":["get","color"],"circle-radius":["interpolate",["linear"],["zoom"],0,["max",3,["*",["get","size"],.2]],5,["max",4,["*",["get","size"],.25]],23,["*",["get","size"],1.6]],"circle-stroke-color":"#ffffff","circle-stroke-width":["interpolate",["linear"],["zoom"],0,.5,8,1.5,15,2],"circle-stroke-opacity":.9}},{id:"persistent-selected-nodes-labels-layer",type:"symbol",source:"persistent-selected-nodes",layout:{"text-font":["Roboto Condensed Regular"],"text-field":["get","name"],"text-anchor":"top","text-max-width":10,"symbol-sort-key":["-",0,["get","textSize"]],"symbol-spacing":500,"text-offset":[0,.5],"text-allow-overlap":!0,"text-size":["interpolate",["linear"],["zoom"],0,["max",6,["/",["get","size"],3]],5,["max",7,["/",["get","size"],2.6]],8,["max",9,["/",["get","size"],2.2]],10,["max",12,["*",["get","size"],.6]],14,["*",["get","size"],1]]},paint:{"text-color":"#fff","text-halo-color":["get","color"],"text-halo-width":3}},{id:"enriched-regions-top-line",type:"line",source:"enriched-regions",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#fff7cf","line-width":["interpolate",["linear"],["zoom"],2,1.4,6,2.6,10,4,14,5.8],"line-opacity":.95}}]}}}function Ge(e){for(const r of L.color)if(r.input===e.fill)return r.output;return e.fill}function Ke(e=[]){let r=1/0,n=1/0,a=-1/0,f=-1/0;return e.forEach(c=>{if(!Array.isArray(c)||c.length<2)return;const s=Number(c[0]),u=Number(c[1]);!Number.isFinite(s)||!Number.isFinite(u)||(s<r&&(r=s),u<n&&(n=u),s>a&&(a=s),u>f&&(f=u))}),[r,n,a,f]}function We(e,r,n=[]){return!Array.isArray(n)||n.length!==4?!1:e>=n[0]&&e<=n[2]&&r>=n[1]&&r<=n[3]}function Xe(e=[]){return["in",["to-string",["get","ownerId"]],["literal",e]]}function X(e=1){const r=Number.isFinite(e)&&e>0?e:1;return["interpolate",["cubic-bezier",.2,0,.7,1],["zoom"],1,["*",r,["step",["get","symbolzoom"],15,4,13,5,12]],9,["*",r,["step",["get","symbolzoom"],22,4,19,5,17]]]}function pe(){return["<=",["get","symbolzoom"],["+",["zoom"],4]]}function de(){return Math.max(1.3,L.placeLabelsHaloWidth+.35)}function Ze(e,r,n,a,f,c,s=1e-9){const u=f-n,m=c-a,y=(e-n)*m-(r-a)*u;if(Math.abs(y)>s)return!1;const z=Math.min(n,f)-s,b=Math.max(n,f)+s,R=Math.min(a,c)-s,E=Math.max(a,c)+s;return e>=z&&e<=b&&r>=R&&r<=E}function Je(e,r,n){let a=!1;for(let f=0,c=e.length-1;f<e.length;c=f++){const s=e[f],u=e[c];if(Ze(r,n,s[0],s[1],u[0],u[1]))return!0;s[1]>n!=u[1]>n&&r<(u[0]-s[0])*(n-s[1])/(u[1]-s[1])+s[0]&&(a=!a)}return a}export{Ve as default};
//# sourceMappingURL=createMap-dec13cbe.js.map
